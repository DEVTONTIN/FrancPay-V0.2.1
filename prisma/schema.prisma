generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ProfileType {
  UTILISATEUR
  PROFESSIONAL
}

enum ProfessionalApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum StakePositionStatus {
  ACTIVE
  REDEEMED
  CANCELLED
}

enum StakeLedgerType {
  STAKE
  UNSTAKE
  REWARD
}

model UserProfile {
  id                String      @id @default(uuid())
  authUserId        String      @unique
  username          String      @unique
  email             String      @unique
  profileType       ProfileType
  referralCode      String?
  referredByCode    String?
  firstName         String?
  lastName          String?
  birthDate         DateTime?
  phoneNumber       String?
  addressLine1      String?
  addressLine2      String?
  postalCode        String?
  city              String?
  country           String?
  transferPinHash   String?
  transferPinSetAt  DateTime?
  pinFailedAttempts Int         @default(0)
  pinLockedUntil    DateTime?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @default(now())

  walletBalance        UserWalletBalance?
  transactions         UserPaymentTransaction[]
  applications         ProfessionalApplication[] @relation("UserProfileApplications")
  reviewedApplications ProfessionalApplication[] @relation("ProfessionalApplicationReviewer")
  stakePositions       UserStakePosition[]
  stakeLedgers         UserStakeLedger[]
  deposits             OnchainDeposit[]

  @@index([profileType])
  @@index([email])
  @@index([city])
  @@index([postalCode])
}

model ProfessionalApplication {
  id                  String                         @id @default(uuid())
  userProfileId       String
  authUserId          String?
  contactEmail        String
  contactPhone        String?
  lastName            String
  firstName           String
  addressLine1        String?
  postalCode          String?
  city                String?
  country             String?
  companyName         String
  legalForm           String?
  siretNumber         String                         @unique
  tvaNumber           String?
  businessWebsite     String?
  activityDescription String?
  status              ProfessionalApplicationStatus  @default(PENDING)
  reviewerId          String?
  reviewedAt          DateTime?
  reviewNotes         String?
  submittedAt         DateTime                       @default(now())
  updatedAt           DateTime                       @default(now())

  userProfile UserProfile @relation("UserProfileApplications", fields: [userProfileId], references: [id], onDelete: Cascade)
  reviewer    UserProfile? @relation("ProfessionalApplicationReviewer", fields: [reviewerId], references: [id], onDelete: SetNull)

  @@index([userProfileId])
  @@index([status])
}

model UserWalletBalance {
  id         String   @id @default(uuid())
  authUserId String   @unique
  balanceFre Decimal  @db.Decimal(18, 2)
  updatedAt  DateTime @default(now())

  profile UserProfile @relation(fields: [authUserId], references: [authUserId], onDelete: Cascade)
}

model UserPaymentTransaction {
  id           String   @id @default(uuid())
  authUserId   String
  context      String
  counterparty String
  amountFre    Decimal  @db.Decimal(18, 2)
  feeFre       Decimal  @db.Decimal(18, 2) @default(0)
  metadata     Json?
  createdAt    DateTime @default(now())

  profile UserProfile @relation(fields: [authUserId], references: [authUserId], onDelete: Cascade)

  @@index([authUserId])
}

model ApplicationFeeLedger {
  id         String   @id @default(uuid())
  context    String
  reference  String?
  amountFre  Decimal  @db.Decimal(18, 2)
  metadata   Json?    @default(dbgenerated("'{}'::jsonb"))
  createdAt  DateTime @default(now())
}

model ApplicationFeeBalance {
  id         Int      @id @default(1)
  balanceFre Decimal  @db.Decimal(18, 2)
  updatedAt  DateTime @default(now())
}

model StakeProduct {
  id            String   @id @default(uuid())
  code          String   @unique
  title         String
  description   String?
  apyPercent    Decimal  @db.Decimal(6, 3)
  lockPeriodDays Int      @default(0)
  minAmountFre  Decimal  @db.Decimal(18, 2) @default(0)
  maxAmountFre  Decimal? @db.Decimal(18, 2)
  isLocked      Boolean  @default(false)
  isActive      Boolean  @default(true)
  metadata      Json     @default(dbgenerated("'{}'::jsonb"))
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now())

  positions UserStakePosition[]

  @@index([isActive])
}

model UserStakePosition {
  id               String              @id @default(uuid())
  authUserId       String
  productId        String
  principalFre     Decimal             @db.Decimal(18, 2)
  rewardAccruedFre Decimal             @db.Decimal(18, 2) @default(0)
  status           StakePositionStatus @default(ACTIVE)
  lockedUntil      DateTime?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @default(now())
  lastRewardAt     DateTime?
  nextRewardAt     DateTime?
  redeemedAt       DateTime?
  productSnapshot  Json                @default(dbgenerated("'{}'::jsonb"))

  product StakeProduct @relation(fields: [productId], references: [id], onDelete: Restrict)
  profile UserProfile  @relation(fields: [authUserId], references: [authUserId], onDelete: Cascade)
  ledger  UserStakeLedger[]

  @@index([authUserId])
  @@index([productId])
  @@index([status])
}

model UserStakeLedger {
  id         String          @id @default(uuid())
  positionId String
  authUserId String
  entryType  StakeLedgerType
  amountFre  Decimal         @db.Decimal(18, 2)
  note       String?
  context    Json?
  createdAt  DateTime        @default(now())

  position UserStakePosition @relation(fields: [positionId], references: [id], onDelete: Cascade)
  profile  UserProfile       @relation(fields: [authUserId], references: [authUserId], onDelete: Cascade)

  @@index([positionId])
  @@index([authUserId])
}

model OnchainDeposit {
  id           String   @id @default(uuid())
  txHash       String   @unique
  walletAddress String
  memoTag      String?
  authUserId   String?
  amountTon    Decimal
  amountFre    Decimal
  status       String   @default("PENDING")
  detectedAt   DateTime @default(now())
  creditedAt   DateTime?
  updatedAt    DateTime @default(now())
  metadata     Json     @default(dbgenerated("'{}'::jsonb"))

  profile UserProfile? @relation(fields: [authUserId], references: [authUserId], onDelete: SetNull)

  @@index([status])
}

model FrePriceSnapshot {
  id           String   @id @default(uuid())
  source       String   @default("gecko_terminal")
  priceUsd     Decimal  @db.Decimal(18, 8)
  priceEur     Decimal  @db.Decimal(18, 8)
  priceTon     Decimal  @db.Decimal(18, 12)
  tonPriceUsd  Decimal  @db.Decimal(18, 8)
  usdToEurRate Decimal  @db.Decimal(18, 8)
  rawPayload   Json?
  fetchedAt    DateTime @default(now())

  @@index([fetchedAt(sort: Desc)], map: "FrePriceSnapshot_fetchedAt_idx")
}
