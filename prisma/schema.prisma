generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  COMPANY_ADMIN
  MANAGER
  OPERATOR
  VIEWER
}

enum WalletStatus {
  ACTIVE
  SUSPENDED
  ARCHIVED
}

enum PaymentRequestStatus {
  DRAFT
  PENDING
  PROCESSING
  CONFIRMED
  FAILED
  CANCELLED
}

enum SettlementStatus {
  PENDING
  CONFIRMED
  FAILED
}

enum WalletConnectionStatus {
  PENDING
  VERIFIED
  REVOKED
}

model Company {
  id                 String             @id @default(uuid())
  name               String
  legalName          String?
  registrationNumber String?            @unique
  contactEmail       String
  contactPhone       String?
  countryCode        String?
  timezone           String?
  kycStatus          String?            @default("pending")
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  users              CompanyUser[]
  wallets            Wallet[]
  clients            Client[]
  paymentRequests    PaymentRequest[]
  auditLogs          AuditLog[]
  walletConnections  WalletConnection[]
  webhookSecrets     WebhookSecret[]

  @@index([name])
}

model CompanyUser {
  id                 String             @id @default(uuid())
  companyId          String
  company            Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  email              String
  fullName           String
  role               UserRole           @default(OPERATOR)
  phone              String?
  invitationAccepted Boolean            @default(false)
  lastLoginAt        DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  auditLogs          AuditLog[]
  walletConnections  WalletConnection[]

  @@unique([companyId, email])
  @@index([companyId])
}

model Wallet {
  id         String           @id @default(uuid())
  companyId  String
  company    Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  label      String
  tonAddress String           @unique
  publicKey  String?
  status     WalletStatus     @default(ACTIVE)
  isPrimary  Boolean          @default(false)
  metadata   Json?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  payments   PaymentRequest[]

  @@index([companyId])
}

model Client {
  id          String           @id @default(uuid())
  companyId   String
  company     Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  name        String
  email       String?
  phone       String?
  externalRef String?
  metadata    Json?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  requests    PaymentRequest[]

  @@index([companyId])
  @@index([externalRef])
}

model PaymentRequest {
  id           String               @id @default(uuid())
  companyId    String
  walletId     String
  clientId     String?
  reference    String               @unique
  amount       Decimal              @db.Decimal(18, 2)
  currency     String               @default("XOF")
  description  String?
  status       PaymentRequestStatus @default(PENDING)
  expiresAt    DateTime?
  metadata     Json?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  company      Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  wallet       Wallet               @relation(fields: [walletId], references: [id], onDelete: Restrict)
  client       Client?              @relation(fields: [clientId], references: [id], onDelete: SetNull)
  settlements  PaymentSettlement[]
  statusEvents PaymentStatusEvent[]

  @@index([companyId])
  @@index([walletId])
  @@index([clientId])
}

model PaymentSettlement {
  id               String           @id @default(uuid())
  paymentRequestId String
  tonTxHash        String?          @unique
  amountRequested  Decimal          @db.Decimal(18, 2)
  amountReceived   Decimal?         @db.Decimal(18, 2)
  networkFee       Decimal?         @db.Decimal(18, 2)
  status           SettlementStatus @default(PENDING)
  failureReason    String?
  settledAt        DateTime?
  rawPayload       Json?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  paymentRequest   PaymentRequest   @relation(fields: [paymentRequestId], references: [id], onDelete: Cascade)

  @@index([paymentRequestId])
}

model PaymentStatusEvent {
  id               String               @id @default(uuid())
  paymentRequestId String
  status           PaymentRequestStatus
  notes            String?
  context          Json?
  createdAt        DateTime             @default(now())
  paymentRequest   PaymentRequest       @relation(fields: [paymentRequestId], references: [id], onDelete: Cascade)

  @@index([paymentRequestId])
}

model WebhookSecret {
  id         String    @id @default(uuid())
  companyId  String
  company    Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  name       String
  secret     String
  url        String
  createdAt  DateTime  @default(now())
  lastUsedAt DateTime?
  isActive   Boolean   @default(true)

  @@index([companyId])
}

model WalletConnection {
  id                 String                 @id @default(uuid())
  companyId          String
  userId             String?
  tonAddress         String
  publicKey          String?
  walletAppName      String?
  deviceInfo         String?
  status             WalletConnectionStatus @default(PENDING)
  lastProofPayload   String?
  lastProofSignature String?
  proofIssuedAt      DateTime?
  proofVerifiedAt    DateTime?
  revokedAt          DateTime?
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  sessions           WalletSession[]
  company            Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user               CompanyUser?           @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([companyId, tonAddress])
  @@index([companyId])
  @@index([userId])
}

model WalletSession {
  id                 String           @id @default(uuid())
  walletConnectionId String
  sessionToken       String           @unique
  expiresAt          DateTime
  revokedAt          DateTime?
  lastActivityAt     DateTime?
  ipAddress          String?
  userAgent          String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  connection         WalletConnection @relation(fields: [walletConnectionId], references: [id], onDelete: Cascade)

  @@index([walletConnectionId])
}

model AuditLog {
  id        String       @id @default(uuid())
  companyId String
  userId    String?
  company   Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user      CompanyUser? @relation(fields: [userId], references: [id], onDelete: SetNull)
  action    String
  entity    String
  entityId  String?
  ipAddress String?
  payload   Json?
  createdAt DateTime     @default(now())

  @@index([companyId])
  @@index([userId])
}
